#!/usr/bin/env bash
set -euo pipefail

while read -r local_ref local_sha remote_ref remote_sha; do
  if [[ -z "${local_sha:-}" || "${local_sha}" == "0000000000000000000000000000000000000000" ]]; then
    continue
  fi

  if [[ "${remote_sha}" == "0000000000000000000000000000000000000000" ]]; then
    if git rev-parse --verify origin/main >/dev/null 2>&1; then
      base_sha="$(git merge-base origin/main "${local_sha}")"
      commit_range="${base_sha}..${local_sha}"
    else
      commit_range="${local_sha}"
    fi
  else
    commit_range="${remote_sha}..${local_sha}"
  fi

  python tools/privacy/privacy_guard.py check-range "${commit_range}"
done
