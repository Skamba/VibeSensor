name: Server Release

on:
  schedule:
    # Nightly at 02:00 UTC
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      force:
        description: "Create release even if no new commits since last release"
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ── Skip-if-unchanged (nightly only) ──────────────────────────
      - name: Check for changes since last server release
        id: changes
        if: github.event_name == 'schedule'
        shell: bash
        run: |
          set -euo pipefail
          latest_tag="$(git tag -l 'server-v*' --sort=-creatordate | head -n1 || true)"
          if [ -z "${latest_tag}" ]; then
            echo "No previous server release tag found; will create first release."
            echo "has_changes=true" >> "${GITHUB_OUTPUT}"
            exit 0
          fi
          diff_count="$(git rev-list --count "${latest_tag}..HEAD")"
          echo "Commits since ${latest_tag}: ${diff_count}"
          if [ "${diff_count}" -eq 0 ]; then
            echo "No new commits; skipping nightly release."
            echo "has_changes=false" >> "${GITHUB_OUTPUT}"
          else
            echo "has_changes=true" >> "${GITHUB_OUTPUT}"
          fi

      - name: Early exit if no changes
        if: github.event_name == 'schedule' && steps.changes.outputs.has_changes == 'false'
        run: echo "Skipping — no changes since last release." && exit 0

      # ── Compute CalVer version ────────────────────────────────────
      - name: Compute version
        id: version
        if: github.event_name != 'schedule' || steps.changes.outputs.has_changes == 'true'
        shell: bash
        run: |
          set -euo pipefail
          base_ver="$(date -u +%Y.%-m.%-d)"
          # Check for same-day releases and append .N suffix
          existing="$(git tag -l "server-v${base_ver}*" | sort -V | tail -n1 || true)"
          if [ -z "${existing}" ]; then
            version="${base_ver}"
          else
            # Extract suffix: server-v2025.1.15.2 → 2
            suffix="${existing##server-v${base_ver}}"
            if [ -z "${suffix}" ]; then
              version="${base_ver}.1"
            else
              n="${suffix#.}"
              version="${base_ver}.$((n + 1))"
            fi
          fi
          echo "version=${version}" >> "${GITHUB_OUTPUT}"
          echo "tag=server-v${version}" >> "${GITHUB_OUTPUT}"
          echo "Computed version: ${version}"

      # ── Build UI ──────────────────────────────────────────────────
      - uses: actions/setup-node@v4
        if: github.event_name != 'schedule' || steps.changes.outputs.has_changes == 'true'
        with:
          node-version: 22

      - name: Build UI
        if: github.event_name != 'schedule' || steps.changes.outputs.has_changes == 'true'
        shell: bash
        run: |
          set -euo pipefail
          # Sync shared contracts to UI before build
          node tools/config/sync_shared_contracts_to_ui.mjs
          cd apps/ui
          npm ci
          npm run typecheck
          npm run build

      - name: Copy UI dist into package static dir
        if: github.event_name != 'schedule' || steps.changes.outputs.has_changes == 'true'
        shell: bash
        run: |
          set -euo pipefail
          rm -rf apps/server/vibesensor/static
          cp -r apps/ui/dist apps/server/vibesensor/static

      # ── Build Python wheel ────────────────────────────────────────
      - uses: actions/setup-python@v5
        if: github.event_name != 'schedule' || steps.changes.outputs.has_changes == 'true'
        with:
          python-version: "3.11"

      - name: Stamp version and build wheel
        if: github.event_name != 'schedule' || steps.changes.outputs.has_changes == 'true'
        shell: bash
        run: |
          set -euo pipefail
          version="${{ steps.version.outputs.version }}"

          # Write version file
          cat > apps/server/vibesensor/_version.py <<PYEOF
          # Auto-generated by CI — do not edit.
          __version__ = "${version}"
          PYEOF
          # Remove leading whitespace from heredoc
          sed -i 's/^          //' apps/server/vibesensor/_version.py

          python -m pip install --upgrade pip build
          python -m build --wheel apps/server/
          ls -la apps/server/dist/

      # ── Generate changelog ────────────────────────────────────────
      - name: Generate changelog
        id: changelog
        if: github.event_name != 'schedule' || steps.changes.outputs.has_changes == 'true'
        shell: bash
        run: |
          set -euo pipefail
          latest_tag="$(git tag -l 'server-v*' --sort=-creatordate | head -n1 || true)"
          if [ -z "${latest_tag}" ]; then
            range="HEAD"
          else
            range="${latest_tag}..HEAD"
          fi
          {
            echo "body<<CHANGELOG_EOF"
            echo "## Changes"
            echo ""
            git log --oneline --no-decorate --max-count=50 "${range}"
            echo ""
            echo "CHANGELOG_EOF"
          } >> "${GITHUB_OUTPUT}"

      # ── Create GitHub Release ─────────────────────────────────────
      - name: Create release
        if: github.event_name != 'schedule' || steps.changes.outputs.has_changes == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Server ${{ steps.version.outputs.version }}
          body: ${{ steps.changelog.outputs.body }}
          prerelease: false
          files: apps/server/dist/*.whl
