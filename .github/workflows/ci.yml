name: CI

on:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: pi/pyproject.toml

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: ui/package-lock.json

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e "./pi[dev]"

      - name: Lint
        run: |
          ruff check pi/vibesensor pi/tests tools/simulator
          ruff format --check pi/vibesensor pi/tests tools/simulator

      - name: Line endings
        run: |
          python tools/config/check_line_endings.py

      - name: UI typecheck + build + sync
        run: |
          python tools/sync_ui_to_pi_public.py
          cd ui
          npm run typecheck


      - name: Unit tests
        run: |
          pytest -q -m "not selenium and not long_sim" pi/tests

      - name: Docker smoke test
        run: |
          set -euo pipefail

          echo "=== Building Docker image ==="
          docker build -f pi/Dockerfile -t vibesensor-ci .

          echo "=== Starting container ==="
          CID=$(docker run -d -p 8080:8000 vibesensor-ci)
          cleanup() { docker logs "$CID" 2>&1 || true; docker rm -f "$CID" >/dev/null 2>&1 || true; }
          trap cleanup EXIT

          echo "=== Waiting for server readiness (up to 60s) ==="
          for i in $(seq 1 60); do
            if curl -sf http://127.0.0.1:8080/api/health >/dev/null 2>&1; then
              echo "Server ready after ${i}s"
              break
            fi
            if [ "$i" -eq 60 ]; then
              echo "FAIL: server did not become ready within 60s"
              exit 1
            fi
            sleep 1
          done

          echo "=== Verifying container is still running ==="
          docker inspect -f '{{.State.Running}}' "$CID" | grep -q true

          echo "=== Health endpoint ==="
          curl -sf http://127.0.0.1:8080/api/health | grep -q '"status":"ok"'

          echo "=== UI served (GET /) ==="
          curl -sf http://127.0.0.1:8080/ | grep -q '</html>'

          echo "=== Static asset exists ==="
          curl -sf http://127.0.0.1:8080/ | grep -qo '/assets/index-[^"]*\.js'

          echo "=== API endpoint (/api/clients) ==="
          curl -sf http://127.0.0.1:8080/api/clients | grep -q '"clients"'

          echo "=== WebSocket upgrade (/ws) ==="
          WS_CODE=$(curl -s -o /dev/null -w '%{http_code}' --max-time 5 \
            -H 'Upgrade: websocket' \
            -H 'Connection: Upgrade' \
            -H 'Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==' \
            -H 'Sec-WebSocket-Version: 13' \
            http://127.0.0.1:8080/ws || true)
          if [ "$WS_CODE" != "101" ]; then
            echo "FAIL: WebSocket upgrade returned $WS_CODE (expected 101)"
            exit 1
          fi

          echo "=== All Docker smoke checks passed ==="

      - name: Config preflight
        run: |
          python tools/config/config_preflight.py pi/config.example.yaml
          python tools/config/config_preflight.py pi/config.dev.yaml

      - name: Simulator + websocket smoke
        run: |
          set -euo pipefail
          python -m vibesensor.app --config pi/config.dev.yaml >server.log 2>&1 &
          SERVER_PID=$!
          cleanup() {
            kill "${SIM_PID:-}" >/dev/null 2>&1 || true
            kill "${SERVER_PID}" >/dev/null 2>&1 || true
          }
          trap cleanup EXIT

          for i in $(seq 1 30); do
            if curl -sf http://127.0.0.1:8000/ >/dev/null; then
              break
            fi
            sleep 1
          done

          python tools/simulator/sim_sender.py \
            --count 3 \
            --duration 20 \
            --server-host 127.0.0.1 \
            --no-auto-server >sim.log 2>&1 &
          SIM_PID=$!
          if ! python tools/simulator/ws_smoke.py \
            --uri ws://127.0.0.1:8000/ws \
            --min-clients 3 \
            --timeout 35 \
            --debug \
            --report-every 1 >ws_smoke.log 2>&1; then
            echo "=== ws_smoke.log ==="
            cat ws_smoke.log || true
            echo "=== sim.log (last 200 lines) ==="
            tail -n 200 sim.log || true
            echo "=== server.log (last 200 lines) ==="
            tail -n 200 server.log || true
            echo "=== /api/clients snapshot ==="
            curl -sv http://127.0.0.1:8000/api/clients || true
            exit 1
          fi
          wait "${SIM_PID}"
