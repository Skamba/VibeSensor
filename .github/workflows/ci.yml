name: CI

on:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: pi/pyproject.toml

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: ui/package-lock.json

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e "./pi[dev]"

      - name: Lint
        continue-on-error: true
        run: |
          ruff check pi/vibesensor pi/tests tools/simulator
          ruff format --check pi/vibesensor pi/tests tools/simulator

      - name: Line endings
        run: |
          python tools/config/check_line_endings.py


      - name: Unit tests
        run: |
          pytest -q -m "not selenium" pi/tests

      - name: UI typecheck + build
        run: |
          cd ui
          npm ci
          npm run typecheck
          npm run build

      - name: Config preflight
        run: |
          python tools/config/config_preflight.py pi/config.example.yaml
          python tools/config/config_preflight.py pi/config.dev.yaml

      - name: Simulator + websocket smoke
        run: |
          set -euo pipefail
          python -m vibesensor.app --config pi/config.dev.yaml >server.log 2>&1 &
          SERVER_PID=$!
          cleanup() {
            kill "${SIM_PID:-}" >/dev/null 2>&1 || true
            kill "${SERVER_PID}" >/dev/null 2>&1 || true
          }
          trap cleanup EXIT

          for i in $(seq 1 30); do
            if curl -sf http://127.0.0.1:8000/ >/dev/null; then
              break
            fi
            sleep 1
          done

          python tools/simulator/sim_sender.py \
            --count 3 \
            --duration 20 \
            --server-host 127.0.0.1 \
            --no-auto-server >sim.log 2>&1 &
          SIM_PID=$!
          if ! python tools/simulator/ws_smoke.py \
            --uri ws://127.0.0.1:8000/ws \
            --min-clients 3 \
            --timeout 35 \
            --debug \
            --report-every 1 >ws_smoke.log 2>&1; then
            echo "=== ws_smoke.log ==="
            cat ws_smoke.log || true
            echo "=== sim.log (last 200 lines) ==="
            tail -n 200 sim.log || true
            echo "=== server.log (last 200 lines) ==="
            tail -n 200 server.log || true
            echo "=== /api/clients snapshot ==="
            curl -sv http://127.0.0.1:8000/api/clients || true
            exit 1
          fi
          wait "${SIM_PID}"
