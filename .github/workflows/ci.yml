name: CI

on:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e "./pi[dev]"

      - name: Lint
        run: |
          ruff check pi/vibesensor pi/tests tools/simulator

      - name: Privacy guard
        run: |
          python tools/privacy/privacy_guard.py check-tree
          python tools/privacy/privacy_guard.py check-range "${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }}"

      - name: Unit tests
        run: |
          pytest -q pi/tests

      - name: Simulator + websocket smoke
        run: |
          set -euo pipefail
          python -m vibesensor.app --config pi/config.dev.yaml >server.log 2>&1 &
          SERVER_PID=$!
          cleanup() {
            kill "${SIM_PID:-}" >/dev/null 2>&1 || true
            kill "${SERVER_PID}" >/dev/null 2>&1 || true
          }
          trap cleanup EXIT

          for i in $(seq 1 30); do
            if curl -sf http://127.0.0.1:8000/ >/dev/null; then
              break
            fi
            sleep 1
          done

          python tools/simulator/sim_sender.py --count 3 --duration 12 --server-host 127.0.0.1 >sim.log 2>&1 &
          SIM_PID=$!
          python tools/simulator/ws_smoke.py --uri ws://127.0.0.1:8000/ws --min-clients 3 --timeout 20
          wait "${SIM_PID}"
