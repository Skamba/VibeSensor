# SSH first-boot root cause analysis (Pi image pipeline)

## Symptom
- On first boot of the generated Pi image, SSH is sometimes unavailable.
- The same image can become SSH-reachable after a later boot/restart.

## Build entrypoints found
- Primary image builder: `infra/pi-image/pi-gen/build.sh`
- Upstream builder invoked by wrapper: `.cache/pi-gen/build-docker.sh` (generated by the wrapper)
- Indirect references/checks: `tools/tests/heuristics_audit.py`, `apps/server/tests/test_ai_smoke.py`

## Target OS and boot model
- The pipeline builds Raspberry Pi OS (Debian Bookworm) via `pi-gen` (`infra/pi-image/pi-gen/build.sh`).
- Init system is `systemd`.
- Standard Pi boot partition + Linux root partition image layout.

## How SSH was enabled before the fix
- Pi-gen stage config enables SSH (`ENABLE_SSH=1`) in `infra/pi-image/pi-gen/build.sh`.
- Upstream `pi-gen` stage2 enables `ssh.service` and `regenerate_ssh_host_keys`:
  - `.cache/pi-gen/stage2/01-sys-tweaks/01-run.sh` lines 25-30
- Upstream stage2 also deletes host keys from the image snapshot:
  - `.cache/pi-gen/stage2/01-sys-tweaks/01-run.sh` line 69

## Reproduction evidence (no hardware)
Using the pipeline output in `pigen_work` rootfs and ARM emulation:

```bash
docker exec pigen_work bash -lc 'cp /usr/bin/qemu-arm-static /pi-gen/work/vibesensor-rpi3a-plus-bookworm-lite/stage-vibesensor/rootfs/usr/bin/qemu-arm-static && chroot /pi-gen/work/vibesensor-rpi3a-plus-bookworm-lite/stage-vibesensor/rootfs /usr/bin/qemu-arm-static /usr/sbin/sshd -t'
```

Observed output:

```text
sshd: no hostkeys available -- exiting.
```

This proves the built image rootfs is not intrinsically SSH-startable until host keys are generated on-device.

## Root cause
The pipeline relied on first-boot unit choreography for host-key generation, but did not enforce SSH first-boot readiness as a deterministic invariant in build validation.

- Host keys are intentionally absent in image snapshots (good for security/uniqueness).
- `sshd` fails hard without host keys.
- Validation previously checked only auth drop-ins, not that SSH can actually start with first-boot key generation semantics.

## Why current scripts produced that state
- Build-time checks in `infra/pi-image/pi-gen/build.sh` verified password-auth drop-in presence/content, but not full SSH readiness path.
- No build-time `sshd` first-boot readiness smoke existed.

## Fix implemented
1. Added deterministic SSH host-key bootstrap drop-in:
   - `infra/pi-image/pi-gen/build.sh` writes `/etc/systemd/system/ssh.service.d/10-vibesensor-hostkeys.conf`
   - Ensures host keys are generated before `sshd` startup (`ssh-keygen -A`) if absent.
2. Added SSH regression checks in image validation:
   - Verify `openssh-server` installed.
   - Verify `ssh.service` enabled and not masked.
   - Verify `regenerate_ssh_host_keys.service` enabled.
   - Verify host-key bootstrap drop-in exists and contains `ssh-keygen -A`.
   - Added ARM qemu smoke that removes host keys, regenerates, then runs `sshd -t`.
3. Added optional first-boot debug hook:
   - Build flag: `SSH_FIRST_BOOT_DEBUG=1`
   - Writes `/boot` (or `/boot/firmware`) `ssh-debug.txt` with `systemctl`/`journalctl` snippets.
4. Added test guard:
   - `apps/server/tests/test_ai_smoke.py` now asserts presence of SSH first-boot validation logic in build wrapper.

## Files changed
- `infra/pi-image/pi-gen/build.sh`
- `apps/server/tests/test_ai_smoke.py`
- `infra/pi-image/pi-gen/README.md`
- `docs/ssh-root-cause.md`

## Notes
- Security posture preserved: no default root login changes, no host key pre-generation in image, no auth widening beyond existing project defaults.
- Local full image rebuild in this environment is currently blocked unless `ripgrep` (`rg`) is installed (`build.sh` uses `rg` during mirror rewrite).
